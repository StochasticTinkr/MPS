package jetbrains.mps.ide.httpsupport.manager.plugin;

/*Generated by MPS */

import org.jetbrains.ide.HttpRequestHandler;
import org.jetbrains.annotations.NotNull;
import io.netty.handler.codec.http.FullHttpRequest;
import io.netty.handler.codec.http.HttpMethod;
import io.netty.handler.codec.http.QueryStringDecoder;
import io.netty.channel.ChannelHandlerContext;
import java.io.IOException;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import org.apache.log4j.Level;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;

public class MPSRequestManager extends HttpRequestHandler {

  @Override
  public boolean isSupported(@NotNull FullHttpRequest request) {
    return request.method() == HttpMethod.GET;
  }

  @Override
  public boolean process(@NotNull QueryStringDecoder decoder, @NotNull FullHttpRequest request, @NotNull ChannelHandlerContext context) throws IOException {
    HttpRequest boxedRequest = new HttpRequest(request, decoder, context.channel());

    for (IHttpRequestHandler handler : Sequence.fromIterable(new ExtensionPoint<IHttpRequestHandler>("jetbrains.mps.ide.httpsupport.HttpRequestHandlerEP").getObjects())) {
      if (handler.canHandle(boxedRequest)) {
        try {
          handler.handle(boxedRequest);
        } catch (Exception e) {
          String errorText = "Request handler '" + handler.applicationID() + "' throws exception: " + e.getMessage();
          boxedRequest.sendResponse(errorText, "text/plain");
          if (LOG.isEnabledFor(Level.ERROR)) {
            LOG.error(errorText, e);
          }
        } finally {
          return true;
        }
      }
    }
    return false;
  }

  protected static Logger LOG = LogManager.getLogger(MPSRequestManager.class);
}

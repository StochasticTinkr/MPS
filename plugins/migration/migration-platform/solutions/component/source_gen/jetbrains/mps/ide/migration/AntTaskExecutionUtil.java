package jetbrains.mps.ide.migration;

/*Generated by MPS */

import jetbrains.mps.project.Project;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.ide.migration.wizard.MigrationSession;
import jetbrains.mps.progress.ProgressMonitorAdapter;
import com.intellij.openapi.progress.EmptyProgressIndicator;
import jetbrains.mps.ide.migration.wizard.MigrationTask;
import jetbrains.mps.ide.migration.wizard.MigrationError;
import jetbrains.mps.migration.global.MigrationOptions;

public class AntTaskExecutionUtil {
  public static boolean migrate(final Project project) throws Exception {
    MigrationRegistry m = ProjectHelper.toIdeaProject(project).getComponent(MigrationRegistry.class);
    if (!(m.isMigrationRequired())) {
      return false;
    }

    MigrationSession session = new AntTaskExecutionUtil.MyMigrationSession(project);
    ProgressMonitorAdapter progress = new ProgressMonitorAdapter(new EmptyProgressIndicator());
    MigrationTask task = new MigrationTask(session, progress) {
      @Override
      protected void error(MigrationError error) {
        throw new RuntimeException(error.getShortMessage());
      }
    };

    task.run();

    project.getRepository().getModelAccess().runWriteInEDT(new Runnable() {
      public void run() {
        project.getRepository().saveAll();
      }
    });

    return true;
  }

  private static class MyMigrationSession extends MigrationSession.MigrationSessionBase {
    private Project myProject;
    private MigrationOptions myOptions = new MigrationOptions();
    private MigrationCheckerImpl myChecker;
    private MigrationExecutorImpl myExecutor;

    public MyMigrationSession(Project project) {
      myProject = project;
      this.myChecker = new MigrationCheckerImpl(myProject, getMigrationRegistry());
      this.myExecutor = new MigrationExecutorImpl(myProject);
    }
    public Project getProject() {
      return myProject;
    }
    public MigrationRegistry getMigrationRegistry() {
      return myProject.getComponent(MigrationRegistry.class);
    }
    public MigrationChecker getChecker() {
      return myChecker;
    }
    public MigrationOptions getOptions() {
      return myOptions;
    }
    @Override
    public MigrationExecutor getExecutor() {
      return myExecutor;
    }
  }
}

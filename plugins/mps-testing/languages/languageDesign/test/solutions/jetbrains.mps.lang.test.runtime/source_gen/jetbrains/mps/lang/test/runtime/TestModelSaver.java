package jetbrains.mps.lang.test.runtime;

/*Generated by MPS */

import jetbrains.mps.lang.test.util.MpsRunListener;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.lang.test.util.RunEventsDispatcher;

/**
 * 
 * 
 * @deprecated each test model must be copied only once (here we are endangered to noclassdeffound
 */
@Deprecated
public class TestModelSaver {
  private static TestModelSaver ourInstance = new TestModelSaver();
  private static MpsRunListener ourListener = createListener();
  private volatile TransformationTest myTest = null;

  @Deprecated
  private TestModelSaver() {
  }

  public static TestModelSaver getInstance() {
    return TestModelSaver.ourInstance;
  }

  public TransformationTest getTest() {
    return myTest;
  }

  public void setTest(TransformationTest test) {
    assert myTest == null;
    myTest = test;
  }

  public void clean() {
    if (myTest == null) {
      return;
    }
    myTest.getProject().getModelAccess().runWriteInEDT(new Runnable() {
      public void run() {
        myTest.dispose();
        myTest = null;
      }
    });
    ModelAccess.instance().flushEventQueue();
  }

  private static MpsRunListener createListener() {
    MpsRunListener listener = new MpsRunListener() {
      @Override
      public void testRunDone() {
        TestModelSaver.ourInstance.clean();
        RunEventsDispatcher.getInstance().removeListener(this);
      }
    };
    RunEventsDispatcher.getInstance().addListener(listener);
    return listener;
  }
}

package jetbrains.mps.ide.mpsmigration.v33;

/*Generated by MPS */

import jetbrains.mps.migration.global.BaseProjectMigration;
import jetbrains.mps.migration.global.CleanupProjectMigration;
import jetbrains.mps.project.Project;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.project.structure.modules.ModuleDescriptor;
import java.util.Map;
import org.jetbrains.mps.openapi.language.SLanguage;
import java.util.HashMap;
import org.jetbrains.mps.openapi.module.SearchScope;
import jetbrains.mps.lang.smodel.query.runtime.CommandUtil;
import jetbrains.mps.lang.smodel.query.runtime.QueryExecutionContext;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.project.Solution;
import jetbrains.mps.project.DevKit;
import java.util.List;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.SModelInternal;
import jetbrains.mps.internal.collections.runtime.ListSequence;

public class FixMigrationVersions_33_331 extends BaseProjectMigration implements CleanupProjectMigration {
  public static final String ID = "jetbrains.mps.fixMig_33_331";

  public FixMigrationVersions_33_331() {
    super(FixMigrationVersions_33_331.ID);
  }

  public void forceExecutionNextTime(Project p) {
    setExecuted(p, false);
  }

  @Override
  public String getDescription() {
    return "Correct used language versions";
  }

  @Override
  public boolean doExecute(Project p) {
    for (AbstractModule m : Sequence.fromIterable(getModulesForCleanup(p))) {
      ModuleDescriptor md = m.getModuleDescriptor();
      if (md == null) {
        continue;
      }

      Map<SLanguage, Integer> oldVersions = md.getLanguageVersions();
      Map<SLanguage, Integer> newVersions = new HashMap<SLanguage, Integer>();
      for (SLanguage lang : oldVersions.keySet()) {
        int newVer = getVerFromModels(m, lang);
        if (oldVersions.get(lang) > newVer) {
          newVersions.put(lang, newVer);
        }
      }

      if (newVersions.isEmpty()) {
        continue;
      }

      oldVersions.putAll(newVersions);
      m.setChanged();
    }
    return true;
  }

  private static Iterable<AbstractModule> getModulesForCleanup(Project p) {
    {
      final SearchScope scope = CommandUtil.createScope(p);
      QueryExecutionContext context = new QueryExecutionContext() {
        public SearchScope getDefaultSearchScope() {
          return scope;
        }
      };
      return Sequence.fromIterable(CommandUtil.modules(CommandUtil.createConsoleScope(null, false, context))).where(new IWhereFilter<SModule>() {
        public boolean accept(SModule it) {
          return !((Solution.isBootstrapSolution(it.getModuleReference()))) && !((it instanceof DevKit));
        }
      }).ofType(AbstractModule.class);
    }
  }

  private static int getVerFromModels(AbstractModule module, final SLanguage lang) {
    int ver = Integer.MAX_VALUE;
    List<SModel> models = module.getModels();
    for (SModelInternal m : ListSequence.fromList(models).ofType(SModelInternal.class).where(new IWhereFilter<SModelInternal>() {
      public boolean accept(SModelInternal it) {
        return it.importedLanguageIds().contains(lang);
      }
    })) {
      int modelVer = m.getLanguageImportVersion(lang);
      if (modelVer != -1) {
        ver = Math.min(ver, modelVer);
      }
    }
    return ver;
  }
}

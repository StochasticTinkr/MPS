package jetbrains.mps.ide.modelchecker.platform.actions;

/*Generated by MPS */

import jetbrains.mps.checkers.IChecker;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.errors.item.IssueKindReportItem;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;
import java.util.List;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.mps.openapi.util.Consumer;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.checkers.AggregatingChecker;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.checkers.FilteringChecker;
import jetbrains.mps.checkers.CatchingChecker;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.errors.item.NodeReportItem;
import org.apache.log4j.Level;
import jetbrains.mps.checkers.SkippingChecker;
import org.jetbrains.mps.openapi.module.SModule;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.util.SubProgressKind;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;

@Deprecated
public class ModelChecker implements IChecker<SModel, IssueKindReportItem> {
  private static final Logger LOG = LogManager.getLogger(ModelChecker.class);
  private final List<SpecificChecker> mySpecificCheckers;
  @Deprecated
  public ModelChecker(@NotNull List<SpecificChecker> specificCheckers) {
    mySpecificCheckers = specificCheckers;
  }
  @Override
  public void check(SModel toCheck, SRepository repository, Consumer<IssueKindReportItem> errorCollector, ProgressMonitor monitor) {
    List<? extends IssueKindReportItem> errors = checkModel(toCheck, monitor);
    for (IssueKindReportItem error : ListSequence.fromList(errors)) {
      errorCollector.consume(error);
    }
  }

  @Deprecated
  public static IChecker<SModel, IssueKindReportItem> createOld(@NotNull List<SpecificChecker> specificCheckers) {
    return new ModelChecker(specificCheckers);
  }

  public static IChecker<SModel, IssueKindReportItem> createNew(@NotNull List<SpecificChecker> specificCheckers) {
    AggregatingChecker<SModel, IssueKindReportItem> catchingAggregation = new AggregatingChecker<SModel, IssueKindReportItem>(ListSequence.fromList(specificCheckers).select(new ISelector<SpecificChecker, FilteringChecker<SModel, IssueKindReportItem>>() {
      public FilteringChecker<SModel, IssueKindReportItem> select(final SpecificChecker specificChecker) {
        return new FilteringChecker<SModel, IssueKindReportItem>(new CatchingChecker<SModel, IssueKindReportItem>(specificChecker, new _FunctionTypes._return_P3_E0<String, SModel, Exception, SRepository>() {
          public String invoke(SModel m, Exception e, SRepository repository) {
            return "Exception while checking model " + m.getName();
          }
        }), new _FunctionTypes._return_P2_E0<Boolean, IssueKindReportItem, SRepository>() {
          public Boolean invoke(IssueKindReportItem item, SRepository repository) {
            SNodeReference node = NodeReportItem.FLAVOUR_NODE.tryToGet(item);
            if (node != null) {
              if (ModelCheckerIssueFinder.filterIssue(node.resolve(repository))) {
                return true;
              } else {
                if (LOG.isEnabledFor(Level.ERROR)) {
                  LOG.error("Specific checker " + specificChecker + " returned error that is supposed to be skipped. Node " + node.getNodeId() + " in model " + node.getModelReference());
                }
                return false;
              }
            } else {
              return true;
            }
          }
        });
      }
    }).toListSequence(), new _FunctionTypes._return_P1_E0<String, SModel>() {
      public String invoke(SModel model) {
        return model.getName().getLongName();
      }
    });

    SkippingChecker<SModel, IssueKindReportItem> skipNullModules = new SkippingChecker<SModel, IssueKindReportItem>(catchingAggregation, new _FunctionTypes._return_P2_E0<Boolean, SModel, SRepository>() {
      public Boolean invoke(SModel model, SRepository repository) {
        SModule module = model.getModule();
        if (module == null) {
          if (LOG.isEnabledFor(Level.WARN)) {
            LOG.warn("Module is null for " + model.getName() + " model");
          }
          return false;
        }
        return true;
      }
    });


    return skipNullModules;
  }


  public List<IssueKindReportItem> checkModel(final SModel model, ProgressMonitor monitor) {
    monitor.start("Checking " + model.getName(), ListSequence.fromList(mySpecificCheckers).count());
    List<IssueKindReportItem> results = ListSequence.fromList(new ArrayList<IssueKindReportItem>());
    try {
      SModule module = model.getModule();

      if (module == null) {
        if (LOG.isEnabledFor(Level.WARN)) {
          LOG.warn("Module is null for " + model.getName() + " model");
        }
        return results;
      }

      for (final SpecificChecker specificChecker : ListSequence.fromList(mySpecificCheckers)) {
        try {
          List<? extends IssueKindReportItem> specificCheckerResults = specificChecker.checkModel(model, monitor.subTask(1, SubProgressKind.AS_COMMENT));
          ListSequence.fromList(results).addSequence(ListSequence.fromList(specificCheckerResults).where(new IWhereFilter<IssueKindReportItem>() {
            public boolean accept(IssueKindReportItem it) {
              SNodeReference node = NodeReportItem.FLAVOUR_NODE.tryToGet(it);
              if (node != null) {
                if (ModelCheckerIssueFinder.filterIssue(node.resolve(model.getRepository()))) {
                  return true;
                } else {
                  if (LOG.isEnabledFor(Level.ERROR)) {
                    LOG.error("Specific checker " + specificChecker + " returned error that is supposed to be skipped. Node " + node.getNodeId() + " in model " + node.getModelReference());
                  }
                  return false;
                }
              } else {
                return true;
              }
            }
          }));
        } catch (Throwable t) {
          if (LOG.isEnabledFor(Level.ERROR)) {
            LOG.error("Error while " + model.getName() + " model checking", t);
          }
        }
        if (monitor.isCanceled()) {
          break;
        }
      }
      return results;
    } finally {
      monitor.done();
    }
  }
}

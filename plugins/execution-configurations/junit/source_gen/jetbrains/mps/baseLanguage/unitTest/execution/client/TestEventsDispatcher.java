package jetbrains.mps.baseLanguage.unitTest.execution.client;

/*Generated by MPS */

import org.jetbrains.annotations.NotNull;
import com.intellij.execution.process.ProcessEvent;
import jetbrains.mps.baseLanguage.unitTest.execution.server.DefaultTestExecutor;
import com.intellij.openapi.util.Key;
import jetbrains.mps.baseLanguage.unitTest.execution.TestEventMessage;
import jetbrains.mps.baseLanguage.unitTest.execution.TestRawEvent;

/**
 * Updates {@link jetbrains.mps.baseLanguage.unitTest.execution.client.TestRunState } with {@link jetbrains.mps.baseLanguage.unitTest.execution.TestEventMessage } and other events from a futher unspecified source (usually a listener of a test execution process)
 */
public final class TestEventsDispatcher {
  private final TestRunState myState;

  public TestEventsDispatcher(@NotNull TestRunState testState) {
    myState = testState;
  }

  public synchronized void onStartNotified(@NotNull ProcessEvent event) {
    myState.onStartNotified();
  }

  public synchronized void onProcessTerminated(@NotNull ProcessEvent event) {
    myState.onTermination(event.getExitCode() == DefaultTestExecutor.EXIT_CODE_FOR_EXCEPTION);
  }

  public synchronized void onSimpleTextAvailable(@NotNull String text, Key textType) {
    myState.onTextAvailable(text, textType);
  }

  public synchronized void onTestEvent(@NotNull TestEventMessage message) {
    String token = message.getToken();
    TestRawEvent event = message.getEvent();
    switch (token) {
      case TestEventMessage.START_TEST:
        myState.onTestStarted(event);
        break;
      case TestEventMessage.FINISH_TEST:
        myState.onTestFinished(event);
        break;
      case TestEventMessage.FAILURE_TEST_BEGIN:
        myState.onTestFailure(event);
        break;
      case TestEventMessage.START_TESTRUN:
        myState.onTestRunStarted();
        break;
      case TestEventMessage.FINISH_TESTRUN:
        myState.onTestRunFinished();
        break;
      case TestEventMessage.ASSUMPTION_FAILURE_TEST_PREFIX:
        myState.onTestAssumptionFailure(event);
        break;
      case TestEventMessage.IGNORE_FAILURE_TEST_PREFIX:
        myState.onTestIgnored(event);
    }
  }
}

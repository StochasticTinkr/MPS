package jetbrains.mps.baseLanguage.unitTest.execution.client;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.unitTest.behavior.ITestCase__BehaviorDescriptor;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import java.util.function.Function;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import jetbrains.mps.baseLanguage.unitTest.behavior.ITestable__BehaviorDescriptor;
import java.util.Set;
import com.intellij.openapi.application.PathMacros;
import java.util.List;
import jetbrains.mps.baseLanguage.execution.api.JvmArgs;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.baseLanguage.unitTest.execution.server.CachingTestExecutor;
import java.util.ArrayList;
import com.intellij.openapi.application.PathManager;
import java.io.File;
import com.intellij.util.lang.UrlClassLoader;
import java.net.URL;
import java.net.URI;
import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.project.facets.JavaModuleFacet;
import org.jetbrains.annotations.NonNls;
import jetbrains.mps.baseLanguage.unitTest.behavior.ITestMethod__BehaviorDescriptor;

public class LanguageTestWrapper extends AbstractTestWrapper<SNode> {
  private final ITestNodeWrapper myTestCase;

  public LanguageTestWrapper(SNode test) {
    super(test, (boolean) ITestCase__BehaviorDescriptor.canRunInProcess_id5_jSk8paieB.invoke(test));
    myTestCase = null;
  }

  public LanguageTestWrapper(@NotNull ITestNodeWrapper testCase, SNode testMethod) {
    super(testMethod, testCase.canRunInProcess());
    myTestCase = testCase;
  }

  @Override
  public boolean isTestCase() {
    return myTestCase == null;
  }

  @Nullable
  @Override
  public ITestNodeWrapper getTestCase() {
    return myTestCase;
  }

  @NotNull
  @Override
  public Iterable<ITestNodeWrapper> getTestMethods() {
    return withNode(new Function<SNode, Iterable<ITestNodeWrapper>>() {
      public Iterable<ITestNodeWrapper> apply(SNode node) {
        if (!(SNodeOperations.isInstanceOf(node, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase")))) {
          return LanguageTestWrapper.super.getTestMethods();
        }
        return ListSequence.fromList(ITestCase__BehaviorDescriptor.getTestMethods_id1RfJDyhAUar.invoke(SNodeOperations.cast(node, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase")))).select(new ISelector<SNode, ITestNodeWrapper>() {
          public ITestNodeWrapper select(SNode it) {
            return TestNodeWrapperFactory.tryToWrap(it);
          }
        }).where(new NotNullWhereFilter<ITestNodeWrapper>()).toListSequence();
      }
    });
  }

  @Override
  @NotNull
  public TestParameters getTestRunParameters() {
    return withNode(new Function<SNode, TestParameters>() {
      public TestParameters apply(SNode node) {
        if (node != null && (boolean) ITestable__BehaviorDescriptor.isMpsStartRequired_id2RMg39tmiFh.invoke(node)) {
          Set<String> userMacroNames = PathMacros.getInstance().getUserMacroNames();
          List<String> jvmArgsWithMacros = ListSequence.fromList(JvmArgs.getDefaultJvmArgs()).union(SetSequence.fromSet(userMacroNames).select(new ISelector<String, String>() {
            public String select(String key) {
              return String.format("-Dpath.macro.%s=\"%s\"", key, jetbrains.mps.project.PathMacros.getInstance().getValue(key));
            }
          })).toListSequence();
          List<String> classPath = getIdeaClasspath();
          return new TestParameters(CachingTestExecutor.class, ListSequence.fromList(classPath).union(ListSequence.fromList(LanguageTestWrapper.super.getTestRunParameters().getClassPath())).toListSequence(), jvmArgsWithMacros);
        } else {
          return LanguageTestWrapper.super.getTestRunParameters();
        }
      }
    });
  }

  private List<String> getPluginClasspath() {
    List<String> path = ListSequence.fromList(new ArrayList<String>());
    String pluginsPath = PathManager.getPreInstalledPluginsPath();
    File pluginsDir = new File(pluginsPath);
    for (File pluginDirFile : pluginsDir.listFiles()) {
      if (pluginDirFile.isDirectory()) {
        // adding classes dir 
        File classesDir = new File(pluginDirFile, "classes");
        if (classesDir.exists()) {
          ListSequence.fromList(path).addElement(classesDir.getAbsolutePath());
        }
        // adding contents of lib dir 
        File libDir = new File(pluginDirFile, "lib");
        if (libDir.exists()) {
          for (File libChild : libDir.listFiles()) {
            if (libChild.isFile()) {
              String name = libChild.getName();
              if (name.toLowerCase().endsWith(".jar") || name.toLowerCase().endsWith(".zip")) {
                ListSequence.fromList(path).addElement(libChild.getAbsolutePath());
              }
            } else {
              ListSequence.fromList(path).addElement(libChild.getAbsolutePath());
            }
          }
        }
      } else {
        ListSequence.fromList(path).addElement(pluginDirFile.getAbsolutePath());
      }
    }
    return path;
  }

  private List<String> getIdeaClasspath() {
    final List<String> result = ListSequence.fromList(new ArrayList<String>());
    ClassLoader classLoader = UrlClassLoader.class.getClassLoader();
    Class cls = classLoader.getClass();
    try {
      List<URL> urls = ((List<URL>) cls.getMethod("getUrls", new Class[0]).invoke(classLoader, new Object[0]));
      for (URL url : urls) {
        ListSequence.fromList(result).addElement(new URI(url.toString()).getPath());
      }
    } catch (Exception ignored) {
    }
    getRepo().getModelAccess().runReadAction(new Runnable() {
      public void run() {
        Iterable<SModuleReference> languageRuntimes = MetaAdapterFactory.getLanguage(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, "jetbrains.mps.lang.test").getLanguageRuntimes();
        for (SModuleReference dep : Sequence.fromIterable(languageRuntimes)) {
          SModule module = dep.resolve(getRepo());
          JavaModuleFacet facet = module.getFacet(JavaModuleFacet.class);
          if (facet != null) {
            ListSequence.fromList(result).addSequence(SetSequence.fromSet(facet.getClassPath()));
          }
        }
        ListSequence.fromList(result).addSequence(ListSequence.fromList(getPluginClasspath()));
      }
    });
    return result;
  }

  @NonNls
  @Override
  public String getFqName() {
    return withNode(new Function<SNode, String>() {
      public String apply(SNode n) {
        return (SNodeOperations.isInstanceOf(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase")) ? ITestCase__BehaviorDescriptor.getClassName_idhGBnqtL.invoke(SNodeOperations.cast(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase"))) : LanguageTestWrapper.super.getFqName());
      }
    });
  }

  @NonNls
  @Override
  public String getName() {
    return withNode(new Function<SNode, String>() {
      public String apply(SNode n) {
        return (SNodeOperations.isInstanceOf(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b27438a3dL, "jetbrains.mps.baseLanguage.unitTest.structure.ITestMethod")) ? ITestMethod__BehaviorDescriptor.getTestName_idhGBohAB.invoke(SNodeOperations.cast(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b27438a3dL, "jetbrains.mps.baseLanguage.unitTest.structure.ITestMethod"))) : check_9og6tg_a0a0a0a0u(SNodeOperations.cast(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase"))));
      }
    });
  }
  private static String check_9og6tg_a0a0a0a0u(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return ITestCase__BehaviorDescriptor.getSimpleClassName_idhSQIE8p.invoke(checkedDotOperand);
    }
    return null;
  }
}

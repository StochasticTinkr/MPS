package jetbrains.mps.baseLanguage.unitTest.execution.client;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.function.Function;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.smodel.behaviour.BHReflection;
import jetbrains.mps.core.aspects.behaviour.SMethodTrimmedId;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import java.util.Set;
import com.intellij.openapi.application.PathMacros;
import jetbrains.mps.baseLanguage.execution.api.JvmArgs;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.baseLanguage.unitTest.execution.server.CachingTestExecutor;
import java.util.ArrayList;
import com.intellij.openapi.application.PathManager;
import java.io.File;
import com.intellij.util.lang.UrlClassLoader;
import java.net.URL;
import java.net.URI;
import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.project.facets.JavaModuleFacet;
import org.jetbrains.annotations.NonNls;

public class LanguageTestWrapper extends AbstractTestWrapper<SNode> {
  public LanguageTestWrapper(SNode test) {
    super(test);
  }

  @Override
  public boolean isTestCase() {
    return withNode(new Function<SNode, Boolean>() {
      public Boolean apply(SNode n) {
        return SNodeOperations.isInstanceOf(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase"));
      }
    });
  }

  @Nullable
  @Override
  public ITestNodeWrapper getTestCase() {
    return withNode(new Function<SNode, ITestNodeWrapper>() {
      public ITestNodeWrapper apply(SNode n) {
        if (check_9og6tg_a0a0a0a4(n)) {
          return TestNodeWrapperFactory.tryToWrap(((SNode) BHReflection.invoke0(SNodeOperations.cast(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b27438a3dL, "jetbrains.mps.baseLanguage.unitTest.structure.ITestMethod")), MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b27438a3dL, "jetbrains.mps.baseLanguage.unitTest.structure.ITestMethod"), SMethodTrimmedId.create("getTestCase", null, "hGBgWVd"))));
        }
        return null;
      }
    });
  }

  @NotNull
  @Override
  public Iterable<ITestNodeWrapper> getTestMethods() {
    return withNode(new Function<SNode, Iterable<ITestNodeWrapper>>() {
      public Iterable<ITestNodeWrapper> apply(SNode node) {
        if (!(SNodeOperations.isInstanceOf(node, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase")))) {
          return LanguageTestWrapper.super.getTestMethods();
        }
        return ListSequence.fromList(((List<SNode>) BHReflection.invoke0(SNodeOperations.cast(node, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase")), MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase"), SMethodTrimmedId.create("getTestMethods", null, "1RfJDyhAUar")))).select(new ISelector<SNode, ITestNodeWrapper>() {
          public ITestNodeWrapper select(SNode it) {
            return TestNodeWrapperFactory.tryToWrap(it);
          }
        }).where(new NotNullWhereFilter<ITestNodeWrapper>()).toListSequence();
      }
    });
  }

  @Override
  @NotNull
  public TestParameters getTestRunParameters() {
    return withNode(new Function<SNode, TestParameters>() {
      public TestParameters apply(SNode node) {
        if (node != null && ((boolean) (Boolean) BHReflection.invoke0(node, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b08a01119L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestable"), SMethodTrimmedId.create("isMpsStartRequired", null, "2RMg39tmiFh")))) {
          Set<String> userMacroNames = PathMacros.getInstance().getUserMacroNames();
          List<String> jvmArgsWithMacros = ListSequence.fromList(JvmArgs.getDefaultJvmArgs()).union(SetSequence.fromSet(userMacroNames).select(new ISelector<String, String>() {
            public String select(String key) {
              return String.format("-Dpath.macro.%s=\"%s\"", key, jetbrains.mps.project.PathMacros.getInstance().getValue(key));
            }
          })).toListSequence();
          List<String> classPath = getIdeaClasspath();
          return new TestParameters(CachingTestExecutor.class, ListSequence.fromList(classPath).union(ListSequence.fromList(LanguageTestWrapper.super.getTestRunParameters().getClassPath())).toListSequence(), jvmArgsWithMacros);
        } else {
          return LanguageTestWrapper.super.getTestRunParameters();
        }
      }
    });
  }

  private List<String> getPluginClasspath() {
    List<String> path = ListSequence.fromList(new ArrayList<String>());
    String pluginsPath = PathManager.getPreInstalledPluginsPath();
    File pluginsDir = new File(pluginsPath);
    for (File pluginDirFile : pluginsDir.listFiles()) {
      if (pluginDirFile.isDirectory()) {
        // adding classes dir 
        File classesDir = new File(pluginDirFile, "classes");
        if (classesDir.exists()) {
          ListSequence.fromList(path).addElement(classesDir.getAbsolutePath());
        }
        // adding contents of lib dir 
        File libDir = new File(pluginDirFile, "lib");
        if (libDir.exists()) {
          for (File libChild : libDir.listFiles()) {
            if (libChild.isFile()) {
              String name = libChild.getName();
              if (name.toLowerCase().endsWith(".jar") || name.toLowerCase().endsWith(".zip")) {
                ListSequence.fromList(path).addElement(libChild.getAbsolutePath());
              }
            } else {
              ListSequence.fromList(path).addElement(libChild.getAbsolutePath());
            }
          }
        }
      } else {
        ListSequence.fromList(path).addElement(pluginDirFile.getAbsolutePath());
      }
    }
    return path;
  }

  private List<String> getIdeaClasspath() {
    final List<String> result = ListSequence.fromList(new ArrayList<String>());
    ClassLoader classLoader = UrlClassLoader.class.getClassLoader();
    Class cls = classLoader.getClass();
    try {
      List<URL> urls = ((List<URL>) cls.getMethod("getUrls", new Class[0]).invoke(classLoader, new Object[0]));
      for (URL url : urls) {
        ListSequence.fromList(result).addElement(new URI(url.toString()).getPath());
      }
    } catch (Exception ignored) {
    }
    getRepo().getModelAccess().runReadAction(new Runnable() {
      public void run() {
        Iterable<SModuleReference> languageRuntimes = MetaAdapterFactory.getLanguage(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, "jetbrains.mps.lang.test").getLanguageRuntimes();
        for (SModuleReference dep : Sequence.fromIterable(languageRuntimes)) {
          SModule module = dep.resolve(getRepo());
          JavaModuleFacet facet = module.getFacet(JavaModuleFacet.class);
          if (facet != null) {
            ListSequence.fromList(result).addSequence(SetSequence.fromSet(facet.getClassPath()));
          }
        }
        ListSequence.fromList(result).addSequence(ListSequence.fromList(getPluginClasspath()));
      }
    });
    return result;
  }

  @NonNls
  @Override
  public String getFqName() {
    return withNode(new Function<SNode, String>() {
      public String apply(SNode n) {
        return (SNodeOperations.isInstanceOf(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase")) ? ((String) BHReflection.invoke0(SNodeOperations.cast(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase")), MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase"), SMethodTrimmedId.create("getClassName", null, "hGBnqtL"))) : LanguageTestWrapper.super.getFqName());
      }
    });
  }

  @NonNls
  @Override
  public String getName() {
    return withNode(new Function<SNode, String>() {
      public String apply(SNode n) {
        return (SNodeOperations.isInstanceOf(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b27438a3dL, "jetbrains.mps.baseLanguage.unitTest.structure.ITestMethod")) ? ((String) BHReflection.invoke0(SNodeOperations.cast(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b27438a3dL, "jetbrains.mps.baseLanguage.unitTest.structure.ITestMethod")), MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b27438a3dL, "jetbrains.mps.baseLanguage.unitTest.structure.ITestMethod"), SMethodTrimmedId.create("getTestName", null, "hGBohAB"))) : check_9og6tg_a0a0a0a0q(SNodeOperations.cast(n, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase"))));
      }
    });
  }
  private static boolean check_9og6tg_a0a0a0a4(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return SNodeOperations.isInstanceOf(checkedDotOperand, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b27438a3dL, "jetbrains.mps.baseLanguage.unitTest.structure.ITestMethod"));
    }
    return false;
  }
  private static String check_9og6tg_a0a0a0a0q(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return ((String) BHReflection.invoke0(checkedDotOperand, MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase"), SMethodTrimmedId.create("getSimpleClassName", null, "hSQIE8p")));
    }
    return null;
  }
}

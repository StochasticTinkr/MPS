package jetbrains.mps.lang.migration.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.ide.platform.actions.core.RefactoringParticipantBase;
import jetbrains.mps.lang.migration.pluginSolution.plugin.UpdateReferencesParticipant.NamedNodeReference;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.ide.platform.actions.core.MoveNodeRefactoringParticipant;
import jetbrains.mps.ide.platform.actions.core.RefactoringParticipant;
import jetbrains.mps.smodel.structure.Extension;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.lang.migration.util.NodeReferenceUtil;
import java.util.List;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.module.SearchScope;
import jetbrains.mps.lang.smodel.query.runtime.CommandUtil;
import jetbrains.mps.lang.smodel.query.runtime.QueryExecutionContext;
import java.util.Collection;
import org.jetbrains.mps.openapi.model.SReference;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.ide.findusages.model.SearchResult;
import jetbrains.mps.ide.platform.actions.core.RefactoringSession;
import jetbrains.mps.lang.migration.behavior.AbstractNodeReference__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class UpdateReferencesParticipant extends RefactoringParticipantBase<NamedNodeReference, NamedNodeReference, SNode, SNode> implements MoveNodeRefactoringParticipant<NamedNodeReference, NamedNodeReference>, RefactoringParticipant.PersistentRefactoringParticipant<NamedNodeReference, NamedNodeReference, SNode, SNode> {

  public static class UpdateReferencesParticipant_extension extends Extension.Default<MoveNodeRefactoringParticipant<?, ?>> {
    public UpdateReferencesParticipant_extension() {
      super("jetbrains.mps.ide.platform.MoveNodeParticipantEP");
    }
    public MoveNodeRefactoringParticipant<?, ?> get() {
      return new UpdateReferencesParticipant();
    }
  }

  public static class NamedNodeReference extends MultiTuple._2<SNodeReference, String> {
    public NamedNodeReference() {
      super();
    }
    public NamedNodeReference(SNodeReference reference, String name) {
      super(reference, name);
    }
    public SNodeReference reference(SNodeReference value) {
      return super._0(value);
    }
    public String name(String value) {
      return super._1(value);
    }
    public SNodeReference reference() {
      return super._0();
    }
    public String name() {
      return super._1();
    }
  }

  public String getId() {
    return "moveNode.updateReferences";
  }
  public static final RefactoringParticipant.Option OPTION = new RefactoringParticipant.Option("moveNode.options.updateReferencesParticipant", "Update references in current project");
  private MoveNodeRefactoringParticipant.MoveNodeRefactoringDataCollector<NamedNodeReference, NamedNodeReference> myDataCollector = new MoveNodeRefactoringParticipant.MoveNodeRefactoringDataCollector<NamedNodeReference, NamedNodeReference>() {
    public NamedNodeReference beforeMove(SNode nodeToMove) {
      return new NamedNodeReference(nodeToMove.getReference(), NodeReferenceUtil.getNodePresentation(nodeToMove));
    }
    public NamedNodeReference afterMove(SNode movedNode) {
      return new NamedNodeReference(movedNode.getReference(), NodeReferenceUtil.getNodePresentation(movedNode));
    }
  };
  public MoveNodeRefactoringParticipant.MoveNodeRefactoringDataCollector<NamedNodeReference, NamedNodeReference> getDataCollector() {
    return myDataCollector;
  }

  public List<RefactoringParticipant.Option> getAvailableOptions(NamedNodeReference initialState, SRepository repository) {
    return ListSequence.fromListAndArray(new ArrayList<RefactoringParticipant.Option>(), OPTION);
  }

  public List<RefactoringParticipant.Change<NamedNodeReference, NamedNodeReference>> getChanges(final NamedNodeReference initialState, SRepository repository, final List<RefactoringParticipant.Option> selectedOptions, SearchScope searchScope) {
    if (!(ListSequence.fromList(selectedOptions).contains(OPTION))) {
      return ListSequence.fromList(new ArrayList<RefactoringParticipant.Change<NamedNodeReference, NamedNodeReference>>());
    }
    {
      final SearchScope scope = CommandUtil.createScope(searchScope);
      QueryExecutionContext context = new QueryExecutionContext() {
        public SearchScope getDefaultSearchScope() {
          return scope;
        }
      };
      final SNode movedNode = initialState.reference().resolve(repository);
      Collection<SReference> usages;
      if (movedNode != null) {
        usages = CommandUtil.usages(CommandUtil.createConsoleScope(null, false, context), movedNode);
      } else {
        usages = Sequence.fromIterable(CommandUtil.references(CommandUtil.createConsoleScope(null, false, context))).where(new IWhereFilter<SReference>() {
          public boolean accept(SReference it) {
            return eq_k8iioh_a0a0a0a0a0a0a0a4a1a21(it.getTargetNodeReference(), initialState.reference());
          }
        }).toListSequence();
      }
      return CollectionSequence.fromCollection(usages).select(new ISelector<SReference, RefactoringParticipant.Change<NamedNodeReference, NamedNodeReference>>() {
        public RefactoringParticipant.Change<NamedNodeReference, NamedNodeReference> select(SReference ref) {
          final SNodeReference containingNode = ref.getSourceNode().getReference();
          final SReferenceLink role = ref.getLink();
          final String resolveInfo = SLinkOperations.getResolveInfo(ref);
          final SearchResults searchResults = new SearchResults(SetSequence.fromSetAndArray(new HashSet<SNode>(), movedNode), ListSequence.fromListAndArray(new ArrayList<SearchResult<SNode>>(), new SearchResult<SNode>(ref.getSourceNode(), "reference")));
          RefactoringParticipant.Change<NamedNodeReference, NamedNodeReference> change = new RefactoringParticipant.Change<NamedNodeReference, NamedNodeReference>() {
            public MoveNodeRefactoringParticipant<NamedNodeReference, NamedNodeReference> getParticipant() {
              return UpdateReferencesParticipant.this;
            }
            public SearchResults getSearchResults() {
              return searchResults;
            }
            public boolean needsToPreserveOldNode() {
              return false;
            }
            public void confirm(final NamedNodeReference finalState, final SRepository repository, RefactoringSession refactoringSession) {
              refactoringSession.registerChange(new Runnable() {
                public void run() {
                  SNode node = containingNode.resolve(repository);
                  if (node == null || (node.getModel() != null)) {
                    return;
                  }
                  node.setReference(role, jetbrains.mps.smodel.SReference.create(role, node, finalState.reference().getModelReference(), finalState.reference().getNodeId(), resolveInfo));
                  if (ListSequence.fromList(selectedOptions).contains(UpdateModelImports.OPTION)) {
                    UpdateModelImports.addModelImport(node.getModel(), finalState.reference().getModelReference().resolve(repository));
                  }
                }
              });
            }
          };
          return change;
        }
      }).toListSequence();
    }
  }
  public SNode serializeInitialState(NamedNodeReference initialState) {
    return NodeReferenceUtil.makeReflection(initialState.reference(), initialState.name());
  }
  public NamedNodeReference deserializeInitialState(SNode serialized) {
    return new NamedNodeReference(AbstractNodeReference__BehaviorDescriptor.getNodeReference_id4uVwhQyQbdz.invoke(serialized), SPropertyOperations.getString(serialized, MetaAdapterFactory.getProperty(0x9074634404fd4286L, 0x97d5b46ae6a81709L, 0x27bf3263be23f0dfL, 0x27bf3263be23f299L, "nodeName")));
  }
  public SNode serializeFinalState(NamedNodeReference finalState) {
    return NodeReferenceUtil.makeReflection(finalState.reference(), finalState.name());
  }
  public NamedNodeReference deserializeFinalState(SNode serialized) {
    return new NamedNodeReference(AbstractNodeReference__BehaviorDescriptor.getNodeReference_id4uVwhQyQbdz.invoke(serialized), SPropertyOperations.getString(serialized, MetaAdapterFactory.getProperty(0x9074634404fd4286L, 0x97d5b46ae6a81709L, 0x27bf3263be23f0dfL, 0x27bf3263be23f299L, "nodeName")));
  }
  private static boolean eq_k8iioh_a0a0a0a0a0a0a0a4a1a21(Object a, Object b) {
    return (a != null ? a.equals(b) : a == b);
  }
}

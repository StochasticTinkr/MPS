package jetbrains.mps.lang.structure.pluginSolution.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.language.LanguageAspectSupport;
import jetbrains.mps.smodel.Generator;
import com.intellij.ide.BrowserUtil;
import jetbrains.mps.smodel.LanguageAspect;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.smodel.language.LanguageRuntime;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.smodel.runtime.ConceptPresentation;
import jetbrains.mps.smodel.runtime.ConceptPresentationAspect;

public class HelpHelper {
  public static HelpHelper.HelpType getDefaultHelpFor(SModule contextModule, SModel contextModel, SNode node) {
    if (helpForNodeIsAvailable(node)) {
      return HelpHelper.HelpType.NODE;
    }
    if (helpForRootIsAvailable(node)) {
      return HelpHelper.HelpType.ROOT_NODE;
    }
    if (helpForAspectIsAvailable(contextModule, contextModel)) {
      return HelpHelper.HelpType.ASPECT;
    }
    return null;
  }
  public static void showHelpFor(SModule contextModule, SModel contextModel, SNode node) {
    HelpHelper.HelpType defaultHelp = getDefaultHelpFor(contextModule, contextModel, node);
    if (defaultHelp == HelpHelper.HelpType.NODE) {
      HelpHelper.showHelpForNode(node);
    } else if (defaultHelp == HelpHelper.HelpType.ROOT_NODE) {
      HelpHelper.showHelpForRoot(node);
    } else if (defaultHelp == HelpHelper.HelpType.ASPECT) {
      HelpHelper.showHelpForAspect(contextModule, contextModel);
    }
  }
  public static boolean helpForNodeIsAvailable(SNode node) {
    if ((node == null)) {
      return false;
    }
    return isNotEmptyString(getHelpURL(node));
  }
  public static boolean helpForRootIsAvailable(SNode node) {
    if ((node == null)) {
      return false;
    }
    return isNotEmptyString(getHelpURL(SNodeOperations.getContainingRoot(node)));
  }
  public static boolean helpForAspectIsAvailable(SModule module, SModel model) {
    if (model == null || module == null) {
      return false;
    }
    if (module instanceof Language) {
      return LanguageAspectSupport.getHelpUrl(model) != null;
    } else {
      return module instanceof Generator;
    }
  }
  public static void showHelpForAspect(SModule contextModule, SModel contextModel) {
    if (contextModule instanceof Language) {
      String url = LanguageAspectSupport.getHelpUrl(contextModel);
      assert url != null : "should have checked that helpForAspectIsAvailable==true";
      BrowserUtil.browse(url);
    } else {
      BrowserUtil.browse(LanguageAspect.CONFLUENCE_BASE + "Generator#Generator-aboutgenerator");
    }
  }
  public static void showHelpForRoot(SNode node) {
    BrowserUtil.browse(getHelpURL(SNodeOperations.getContainingRoot(node)));
  }
  public static void showHelpForNode(SNode node) {
    BrowserUtil.browse(getHelpURL(node));
  }
  public static String getHelpURL(SNode n) {
    SRepository repo = check_nv0oxj_a0a0a8(check_nv0oxj_a0a0a0i(n)).getRepository();
    if (repo == null) {
      return null;
    }

    LanguageRuntime lang = LanguageRegistry.getInstance(repo).getLanguage(SNodeOperations.getConcept(n).getLanguage());
    ConceptPresentation conceptPres = check_nv0oxj_a0e0i(lang.getAspect(ConceptPresentationAspect.class), n);
    if (conceptPres == null) {
      return null;
    }

    return conceptPres.getHelpUrl();
  }
  public enum HelpType {
    NODE("node"),
    ROOT_NODE("root"),
    ASPECT("aspect");

    private String myName;
    HelpType(String name) {
      this.myName = name;
    }
    public String getName() {
      return this.myName;
    }
  }
  private static SModule check_nv0oxj_a0a0a8(SModel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModule();
    }
    return null;
  }
  private static SModel check_nv0oxj_a0a0a0i(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModel();
    }
    return null;
  }
  private static ConceptPresentation check_nv0oxj_a0e0i(ConceptPresentationAspect checkedDotOperand, SNode n) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getDescriptor(SNodeOperations.getConcept(n));
    }
    return null;
  }
  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }
}

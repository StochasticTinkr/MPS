package jetbrains.mps.vcs.platform.actions;

/*Generated by MPS */

import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;
import jetbrains.mps.project.MPSProject;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.annotations.Nullable;
import com.intellij.openapi.vfs.VirtualFile;
import org.jetbrains.mps.openapi.persistence.DataSource;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.extapi.persistence.FileDataSource;
import jetbrains.mps.persistence.FilePerRootDataSource;
import jetbrains.mps.project.MPSExtentions;
import jetbrains.mps.ide.vfs.VirtualFileUtils;
import jetbrains.mps.vcs.diff.ui.common.Bounds;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.vcs.AbstractVcs;
import com.intellij.openapi.vcs.ProjectLevelVcsManager;
import com.intellij.openapi.vcs.diff.DiffProvider;
import com.intellij.openapi.vcs.history.VcsRevisionNumber;
import com.intellij.openapi.vcs.changes.ContentRevision;
import org.jetbrains.mps.openapi.model.SNodeId;
import com.intellij.diff.DiffContentFactory;
import java.util.List;
import com.intellij.diff.contents.DiffContent;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import com.intellij.diff.requests.DiffRequest;
import com.intellij.diff.requests.SimpleDiffRequest;
import jetbrains.mps.vcs.platform.integration.ModelDiffViewer;
import com.intellij.diff.DiffManager;
import com.intellij.openapi.vcs.VcsException;
import org.apache.log4j.Level;
import com.intellij.openapi.ui.Messages;
import com.intellij.openapi.vcs.impl.VcsFileStatusProvider;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Iterator;
import jetbrains.mps.baseLanguage.closures.runtime.YieldingIterator;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.intellij.openapi.vcs.FileStatus;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.project.AbstractModule;
import java.util.Collections;
import jetbrains.mps.internal.collections.runtime.ITranslator2;

public final class VcsActionsUtil {
  private static final Logger LOG = LogManager.getLogger(VcsActionsUtil.class);
  private final MPSProject myProject;
  private final SNode myNode;
  private final String myContainingRootName;

  public VcsActionsUtil(MPSProject mpsProject, SNode node, String containingRootName) {
    myProject = mpsProject;
    myNode = node;
    myContainingRootName = containingRootName;
  }

  @Nullable
  public VirtualFile detectVirtualFile() {
    DataSource source = myNode.getModel().getSource();
    IFile iFile;
    if (source instanceof FileDataSource) {
      iFile = ((FileDataSource) source).getFile();
    } else if (source instanceof FilePerRootDataSource) {
      iFile = ((FilePerRootDataSource) source).getFile(myContainingRootName + '.' + MPSExtentions.MODEL_ROOT);
    } else {
      return null;
    }
    return VirtualFileUtils.getProjectVirtualFile(iFile);
  }

  public void showRootDifference(@Nullable Bounds bounds) {
    final Project ideaProject = myProject.getProject();
    try {
      VirtualFile vFile = detectVirtualFile();
      assert vFile != null;
      AbstractVcs vcs = ProjectLevelVcsManager.getInstance(ideaProject).getVcsFor(vFile);
      assert vcs != null;
      DiffProvider diffProvider = vcs.getDiffProvider();
      assert diffProvider != null;
      VcsRevisionNumber revisionNumber = diffProvider.getCurrentRevision(vFile);
      ContentRevision revision = diffProvider.createFileContent(revisionNumber, vFile);
      final SNodeId id = myNode.getNodeId();

      DiffContentFactory diffContentFactory = DiffContentFactory.getInstance();
      List<DiffContent> contents = ListSequence.fromListAndArray(new ArrayList<DiffContent>(), diffContentFactory.create(revision.getContent(), vFile.getFileType()), diffContentFactory.create(ideaProject, vFile));
      List<String> titles = ListSequence.fromListAndArray(new ArrayList<String>(), revisionNumber.asString() + " (Read-Only)", "Your Version");
      DiffRequest request = new SimpleDiffRequest(myContainingRootName, contents, titles);
      // put hint to show only one root and navigate 
      request.putUserData(ModelDiffViewer.DIFF_SHOW_ROOTID, id);
      request.putUserData(ModelDiffViewer.DIFF_NAVIGATE_TO, bounds);
      DiffManager.getInstance().showDiff(ideaProject, request);
    } catch (VcsException e) {
      if (LOG.isEnabledFor(Level.WARN)) {
        LOG.warn("", e);
      }
      Messages.showErrorDialog(ideaProject, "Can't show difference due to the following error: " + e.getMessage(), "Error");
    }
  }

  private static Iterable<VirtualFile> collectUnversionedFiles(final VcsFileStatusProvider fileStatusProvider, @NotNull final VirtualFile dir) {
    return new _FunctionTypes._return_P0_E0<Iterable<VirtualFile>>() {
      public Iterable<VirtualFile> invoke() {
        return new Iterable<VirtualFile>() {
          public Iterator<VirtualFile> iterator() {
            return new YieldingIterator<VirtualFile>() {
              private int __CP__ = 0;
              protected boolean moveToNext() {
__loop__:
                do {
__switch__:
                  switch (this.__CP__) {
                    case -1:
                      assert false : "Internal error";
                      return false;
                    case 4:
                      this._5_child_it = Sequence.fromIterable(Sequence.fromArray(dir.getChildren())).iterator();
                    case 6:
                      if (!(this._5_child_it.hasNext())) {
                        this.__CP__ = 1;
                        break;
                      }
                      this._5_child = this._5_child_it.next();
                      this.__CP__ = 7;
                      break;
                    case 8:
                      this._8__yield_brpb5o_a0b0a0a0k_it = Sequence.fromIterable(collectUnversionedFiles(fileStatusProvider, _5_child)).iterator();
                    case 9:
                      if (!(this._8__yield_brpb5o_a0b0a0a0k_it.hasNext())) {
                        this.__CP__ = 6;
                        break;
                      }
                      this._8__yield_brpb5o_a0b0a0a0k = this._8__yield_brpb5o_a0b0a0a0k_it.next();
                      this.__CP__ = 10;
                      break;
                    case 2:
                      if (fileStatusProvider.getFileStatus(dir) == FileStatus.UNKNOWN) {
                        this.__CP__ = 3;
                        break;
                      }
                      this.__CP__ = 4;
                      break;
                    case 5:
                      this.__CP__ = 4;
                      this.yield(dir);
                      return true;
                    case 11:
                      this.__CP__ = 9;
                      this.yield(_8__yield_brpb5o_a0b0a0a0k);
                      return true;
                    case 0:
                      this.__CP__ = 2;
                      break;
                    case 3:
                      this.__CP__ = 5;
                      break;
                    case 7:
                      this.__CP__ = 8;
                      break;
                    case 10:
                      this.__CP__ = 11;
                      break;
                    default:
                      break __loop__;
                  }
                } while (true);
                return false;
              }
              private VirtualFile _5_child;
              private Iterator<VirtualFile> _5_child_it;
              private VirtualFile _8__yield_brpb5o_a0b0a0a0k;
              private Iterator<VirtualFile> _8__yield_brpb5o_a0b0a0a0k_it;
            };
          }
        };
      }
    }.invoke();
  }

  public static Iterable<VirtualFile> getUnversionedFilesForModule(@NotNull Project project, @NotNull SModule module) {
    IFile descriptorFile = ((AbstractModule) module).getDescriptorFile();
    if (descriptorFile == null) {
      return Sequence.fromIterable(Collections.<VirtualFile>emptyList());
    }
    IFile moduleDir = descriptorFile.getParent();
    VcsFileStatusProvider statusProvider = project.getComponent(VcsFileStatusProvider.class);
    VirtualFile virtualFile = VirtualFileUtils.getVirtualFile(moduleDir);
    if (virtualFile == null) {
      return Sequence.fromIterable(Collections.<VirtualFile>emptyList());
    }
    return collectUnversionedFiles(statusProvider, virtualFile);
  }
  public static List<VirtualFile> getUnversionedFilesForModules(@NotNull final Project project, List<SModule> module) {
    return ListSequence.fromList(module).translate(new ITranslator2<SModule, VirtualFile>() {
      public Iterable<VirtualFile> translate(SModule m) {
        return getUnversionedFilesForModule(project, m);
      }
    }).toListSequence();
  }
}

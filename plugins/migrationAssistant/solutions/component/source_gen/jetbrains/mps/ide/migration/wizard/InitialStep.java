package jetbrains.mps.ide.migration.wizard;

/*Generated by MPS */

import java.util.Map;
import jetbrains.mps.migration.global.ProjectMigrationWithOptions;
import javax.swing.JComponent;
import java.util.HashMap;
import java.awt.Dimension;
import javax.swing.BoxLayout;
import javax.swing.JPanel;
import javax.swing.Box;
import com.intellij.ui.IdeBorderFactory;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.project.Project;
import javax.swing.tree.DefaultMutableTreeNode;
import jetbrains.mps.ide.migration.MigrationManager;
import java.util.List;
import jetbrains.mps.ide.migration.ScriptApplied;
import jetbrains.mps.lang.migration.runtime.base.MigrationModuleUtil;
import jetbrains.mps.internal.collections.runtime.ISelector;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.migration.global.ProjectMigration;
import jetbrains.mps.migration.global.CleanupProjectMigration;
import javax.swing.JTree;
import com.intellij.ui.components.JBScrollPane;
import java.awt.BorderLayout;
import com.intellij.ide.wizard.AbstractWizardStepEx;
import com.intellij.ide.wizard.CommitStepException;
import jetbrains.mps.internal.collections.runtime.SetSequence;

public class InitialStep extends BaseStep {
  public static final String ID = "initial";

  private MigrationSession mySession;
  private Map<ProjectMigrationWithOptions.Option, JComponent> myComponents = new HashMap<ProjectMigrationWithOptions.Option, JComponent>();

  public InitialStep(MigrationSession session) {
    super("Migration Required", ID);
    mySession = session;
  }

  @Override
  protected void doCreateComponent(JComponent mainPanel) {
    // Set preferred size to avoid trim of Help button (if no icon presented) 
    mainPanel.setPreferredSize(new Dimension(400, 200));

    mainPanel.setLayout(new BoxLayout(mainPanel, BoxLayout.Y_AXIS));
    mainPanel.add(createInfoPanel("<html>This project should be migrated.<br><br>" + "Migrations to be applied:<br></html>"));

    JPanel infoPanel = new JPanel();
    infoPanel.setLayout(new BoxLayout(infoPanel, BoxLayout.X_AXIS));
    infoPanel.add(Box.createRigidArea(new Dimension()));
    infoPanel.add(createMigrationsInfo());
    infoPanel.add(Box.createRigidArea(new Dimension()));
    mainPanel.add(infoPanel);

    if (!(myComponents.isEmpty())) {
      JPanel settingsPanel = new JPanel();
      settingsPanel.setLayout(new BoxLayout(settingsPanel, BoxLayout.Y_AXIS));
      settingsPanel.setBorder(IdeBorderFactory.createTitledBorder("Options", true));
      for (ProjectMigrationWithOptions.Option option : ListSequence.fromList(mySession.getOptions().optionsList())) {
        JComponent c = option.createComponent();
        myComponents.put(option, c);
        settingsPanel.add(c);
      }
      mainPanel.add(settingsPanel);
    }
  }

  private JComponent createMigrationsInfo() {
    final Project project = mySession.getProject();
    // root 
    final DefaultMutableTreeNode root = new DefaultMutableTreeNode("empty");

    project.getRepository().getModelAccess().runReadAction(new Runnable() {
      public void run() {
        final MigrationManager manager = mySession.getMigrationManager();
        List<ScriptApplied.ScriptAppliedReference> moduleMigrations = manager.getModuleMigrationsToApply(MigrationModuleUtil.getMigrateableModulesFromProject(project));

        // categories 
        final DefaultMutableTreeNode croot = new DefaultMutableTreeNode("Cleanups");
        final DefaultMutableTreeNode proot = new DefaultMutableTreeNode("Project Migrations");
        final DefaultMutableTreeNode lroot = new DefaultMutableTreeNode("Module Migrations (" + ListSequence.fromList(moduleMigrations).select(new ISelector<ScriptApplied.ScriptAppliedReference, SModule>() {
          public SModule select(ScriptApplied.ScriptAppliedReference it) {
            return it.getModule();
          }
        }).distinct().count() + " modules)");

        Sequence.fromIterable(manager.getProjectMigrationsToApply()).visitAll(new IVisitor<ProjectMigration>() {
          public void visit(ProjectMigration it) {
            DefaultMutableTreeNode node = new DefaultMutableTreeNode(it.getDescription());
            if (it instanceof CleanupProjectMigration) {
              croot.add(node);
            } else {
              proot.add(node);
            }
          }
        });
        if (croot.children().hasMoreElements()) {
          root.add(croot);
        }
        if (proot.children().hasMoreElements()) {
          root.add(proot);
        }

        ListSequence.fromList(moduleMigrations).visitAll(new IVisitor<ScriptApplied.ScriptAppliedReference>() {
          public void visit(ScriptApplied.ScriptAppliedReference it) {
            // todo group by language, group by migration type 
            // todo make an icon 
            String caption = it.getKindDescription(it.resolve(manager.getMigrationComponent(), false));
            lroot.add(new DefaultMutableTreeNode(caption));
          }
        });
        if (ListSequence.fromList(moduleMigrations).isNotEmpty()) {
          root.add(lroot);
        }
      }
    });
    JTree tree = new JTree(root);
    tree.setRootVisible(false);
    for (int i = 0; i < tree.getRowCount(); i++) {
      tree.expandRow(i);
    }
    JBScrollPane scrollPane = new JBScrollPane(tree);

    JPanel panel = new JPanel(new BorderLayout());
    panel.add(scrollPane, BorderLayout.CENTER);
    panel.setPreferredSize(new Dimension((int) panel.getPreferredSize().getWidth(), 100));
    return panel;
  }

  @Override
  public Object getNextStepId() {
    return MigrationStep.ID;
  }

  @Override
  public Object getPreviousStepId() {
    return null;
  }

  @Override
  public String cancelButtonLabel() {
    return "Cancel";
  }
  @Override
  public String nextButtonLabel() {
    return "Migrate";
  }

  @Override
  public void commit(AbstractWizardStepEx.CommitType commitType) throws CommitStepException {
    super.commit(commitType);

    for (ProjectMigrationWithOptions.Option option : SetSequence.fromSet(myComponents.keySet())) {
      JComponent c = myComponents.get(option);
      Object val = option.getValue(c);
      mySession.getOptions().setOptionValue(option, val);
    }
  }
}

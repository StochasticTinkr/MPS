package jetbrains.mps.testbench.junit.suites;

/*Generated by MPS */

import jetbrains.mps.project.Project;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.make.MPSCompilationResult;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.make.ModuleMaker;
import jetbrains.mps.util.IterableUtil;
import jetbrains.mps.progress.EmptyProgressMonitor;
import jetbrains.mps.compiler.JavaCompilerOptionsComponent;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.classloading.ClassLoaderManager;

public class TestMakeUtil {
  public static void make(Project p) {
    final Wrappers._T<MPSCompilationResult> mpsCompilationResult = new Wrappers._T<MPSCompilationResult>();
    (p == null ? MPSModuleRepository.getInstance() : p.getRepository()).getModelAccess().runReadAction(new Runnable() {
      public void run() {
        ModuleMaker maker = new ModuleMaker();
        mpsCompilationResult.value = maker.make(IterableUtil.asCollection(MPSModuleRepository.getInstance().getModules()), new EmptyProgressMonitor(), JavaCompilerOptionsComponent.DEFAULT_JAVA_COMPILER_OPTIONS);
      }
    });
    if (mpsCompilationResult.value.isReloadingNeeded()) {
      ModelAccess.instance().runWriteAction(new Runnable() {
        public void run() {
          ClassLoaderManager.getInstance().reloadModules(mpsCompilationResult.value.getChangedModules());
        }
      });
    }
  }

}

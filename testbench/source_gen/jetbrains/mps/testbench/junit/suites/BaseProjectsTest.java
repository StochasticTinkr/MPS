package jetbrains.mps.testbench.junit.suites;

/*Generated by MPS */

import org.junit.runner.RunWith;
import jetbrains.mps.testbench.junit.runners.TeamCityParameterizedRunner;
import jetbrains.mps.tool.environment.Environment;
import jetbrains.mps.project.Project;
import org.junit.runners.Parameterized;
import java.util.List;
import java.lang.reflect.InvocationTargetException;
import jetbrains.mps.tool.environment.EnvironmentConfig;
import jetbrains.mps.tool.environment.IdeaEnvironment;
import java.util.ArrayList;
import com.intellij.openapi.vfs.VirtualFile;
import com.intellij.openapi.vfs.LocalFileSystem;
import com.intellij.openapi.vfs.VfsUtil;
import com.intellij.util.Processor;
import org.junit.Before;
import java.io.File;
import org.junit.After;
import jetbrains.mps.project.MPSProject;
import com.intellij.ide.startup.impl.StartupManagerImpl;
import com.intellij.openapi.startup.StartupManager;
import com.intellij.openapi.application.ApplicationManager;
import com.intellij.ide.impl.ProjectUtil;
import com.intellij.openapi.application.ModalityState;
import com.intellij.util.ui.UIUtil;

@RunWith(value = TeamCityParameterizedRunner.class)
public class BaseProjectsTest {
  public static final String MIGRATION_PLUGIN = "migrationAssistant";
  public static final String MIGRATION_PLUGIN_ID = "jetbrains.mps.ide.migration.assistant";

  private static Environment ourEnv;

  private String myProjectDir;
  private Project myProject;

  public BaseProjectsTest(String projectDir) {
    myProjectDir = projectDir;
  }

  @Parameterized.Parameters
  public static List<Object[]> testParameters() throws InvocationTargetException, InterruptedException {
    EnvironmentConfig defaultConfig = EnvironmentConfig.defaultConfig();
    // todo generalize it when there are more tests 
    defaultConfig.addPlugin(MIGRATION_PLUGIN, MIGRATION_PLUGIN_ID);

    ourEnv = IdeaEnvironment.getOrCreate(defaultConfig);
    ArrayList<Object[]> res = new ArrayList<Object[]>();

    String projectsDir = System.getProperty("projects_dir");
    VirtualFile projectsRoot = LocalFileSystem.getInstance().findFileByPath(projectsDir);

    final List<Object[]> projects = new ArrayList<Object[]>();
    VfsUtil.processFilesRecursively(projectsRoot, new Processor<VirtualFile>() {
      public boolean process(VirtualFile file) {
        if (!(file.isValid()) || !(file.isDirectory())) {
          return true;
        }
        // is a project dir? 
        if (!(file.getName().equals(".mps"))) {
          return true;
        }
        projects.add(new String[]{file.getParent().getPath()});
        return true;
      }
    });

    return projects;
  }

  @Before
  public void openProject() {
    myProject = ourEnv.openProject(new File(myProjectDir));
    waitForInvocations();
  }

  @After
  public void closeProject() {
    waitForInvocations();
    final com.intellij.openapi.project.Project project = ((MPSProject) myProject).getProject();
    final StartupManagerImpl instance = (StartupManagerImpl) StartupManager.getInstance(project);
    instance.prepareForNextTest();
    ApplicationManager.getApplication().invokeAndWait(new Runnable() {
      public void run() {
        ProjectUtil.closeAndDispose(project);
      }
    }, ModalityState.NON_MODAL);
    waitForInvocations();
  }

  private static void waitForInvocations() {
    UIUtil.invokeAndWaitIfNeeded(new Runnable() {
      public void run() {
        UIUtil.dispatchAllInvocationEvents();
      }
    });
  }

  public Project getContextProject() {
    return myProject;
  }

  public String getProjectDir() {
    return myProjectDir;
  }
}

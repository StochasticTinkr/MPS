package CloneModule.test.test;

/*Generated by MPS */

import junit.framework.TestCase;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.project.Project;
import jetbrains.mps.project.Solution;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.project.MPSExtentions;
import jetbrains.mps.ide.newModuleDialogs.CopyModuleHelper;
import jetbrains.mps.project.AbstractModule;
import junit.framework.Assert;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.tool.environment.Environment;
import jetbrains.mps.tool.environment.IdeaEnvironment;
import jetbrains.mps.tool.environment.EnvironmentConfig;
import java.io.File;
import jetbrains.mps.vfs.IFileUtils;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;
import jetbrains.mps.project.validation.MessageCollectProcessor;
import jetbrains.mps.project.validation.ValidationUtil;
import org.apache.log4j.Level;

public class CloneModule_Test extends TestCase {
  private static final String PROJECT_PATH = "../testbench/modules/testCloneModule/";
  private IFile clonedModulesDirectory;
  private Project project;
  public void test_cloneSolution_Default() throws Exception {
    executeUnderLock(new Runnable() {
      public void run() {
        Solution originalSolution = as_i3fixg_a0a0a0a0a0a0d(PersistenceFacade.getInstance().createModuleReference("b91ce146-26c2-4e84-83a2-8f8e9f81ba91(TestSolution_DefaultModelRoot)").resolve(project.getRepository()), Solution.class);

        String clonedSolutionName = originalSolution.getModuleName() + "_clone_default";

        IFile copyLocation = clonedModulesDirectory.getDescendant(clonedSolutionName + MPSExtentions.DOT_SOLUTION);
        CopyModuleHelper helper = new CopyModuleHelper(project, originalSolution, clonedSolutionName, copyLocation, "");
        AbstractModule clonedSolution = helper.copy();

        Assert.assertEquals(clonedSolution.getModuleName(), clonedSolutionName);

        checkModule(originalSolution);
        checkModule(clonedSolution);
      }
    });
  }
  public void test_cloneSolution_StubsClone() throws Exception {
    executeUnderLock(new Runnable() {
      public void run() {
        Solution originalSolution = as_i3fixg_a0a0a0a0a0a0e(PersistenceFacade.getInstance().createModuleReference("8f96adf3-4f4a-468b-b857-347988bd14bd(TestSolution_JavaClasses)").resolve(project.getRepository()), Solution.class);

        String clonedSolutionName = originalSolution.getModuleName() + "_clone_stubs";

        IFile copyLocation = clonedModulesDirectory.getDescendant(clonedSolutionName + MPSExtentions.DOT_SOLUTION);

        CopyModuleHelper helper = new CopyModuleHelper(project, originalSolution, clonedSolutionName, copyLocation, "");
        AbstractModule clonedSolution = helper.copy();

        checkModule(originalSolution);
        checkModule(clonedSolution);
      }
    });
  }
  public void test_cloneLanguage() throws Exception {
    executeUnderLock(new Runnable() {
      public void run() {
        Language originalLanguage = as_i3fixg_a0a0a0a0a0a0f(PersistenceFacade.getInstance().createModuleReference("d1ea9b08-060f-4f7d-83b7-0f97f71cbbf7(TestLanguage)").resolve(project.getRepository()), Language.class);

        String clonedLanguageName = originalLanguage.getModuleName() + "_clone_language";

        IFile copyLocation = clonedModulesDirectory.getDescendant(clonedLanguageName + MPSExtentions.DOT_LANGUAGE);

        CopyModuleHelper helper = new CopyModuleHelper(project, originalLanguage, clonedLanguageName, copyLocation, "");
        AbstractModule clonedLanguage = helper.copy();

        checkModule(originalLanguage);
        checkModule(clonedLanguage);
      }
    });
  }
  public void setUp() {
    Environment env = IdeaEnvironment.getOrCreate(EnvironmentConfig.defaultConfig());
    project = env.openProject(new File(PROJECT_PATH));

    executeUnderLock(new Runnable() {
      public void run() {
        clonedModulesDirectory = IFileUtils.createTmpDir();
      }
    });
  }
  public void tearDown() {
    executeUnderLock(new Runnable() {
      public void run() {
        clonedModulesDirectory.delete();
      }
    });
  }

  protected static Logger LOG = LogManager.getLogger(CloneModule_Test.class);
  public static void checkModule(AbstractModule module) {
    MessageCollectProcessor processor = new MessageCollectProcessor();
    ValidationUtil.validateModule(module, processor);
    if (!(processor.getErrors().isEmpty())) {
      for (String error : processor.getErrors()) {
        if (LOG.isEnabledFor(Level.ERROR)) {
          LOG.error("Error found while checking '" + module + "': " + error);
        }
      }
      org.junit.Assert.fail();
    }
  }

  public void executeUnderLock(Runnable runnable) {
    project.getModelAccess().executeCommandInEDT(runnable);
  }
  private static <T> T as_i3fixg_a0a0a0a0a0a0d(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_i3fixg_a0a0a0a0a0a0e(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_i3fixg_a0a0a0a0a0a0f(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}

package jetbrains.mps.checkers.test;

/*Generated by MPS */

import jetbrains.mps.MPSLaunch;
import jetbrains.mps.lang.test.runtime.BaseTransformationTest;
import org.junit.ClassRule;
import jetbrains.mps.lang.test.runtime.TestParametersCache;
import org.junit.Rule;
import jetbrains.mps.lang.test.runtime.RunWithCommand;
import org.junit.Test;
import jetbrains.mps.lang.test.runtime.BaseTestBody;
import jetbrains.mps.lang.test.runtime.TransformationTest;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import java.util.List;
import jetbrains.mps.errors.item.NodeReportItem;
import jetbrains.mps.typesystemEngine.checker.TypesystemChecker;
import junit.framework.Assert;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.checkers.IChecker;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.tempmodel.TemporaryModels;
import jetbrains.mps.smodel.tempmodel.TempModuleOptions;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import java.util.ArrayList;
import jetbrains.mps.util.CollectConsumer;
import jetbrains.mps.progress.EmptyProgressMonitor;
import jetbrains.mps.smodel.references.ImmatureReferences;
import jetbrains.mps.smodel.references.UnregisteredNodes;
import jetbrains.mps.errors.item.IssueKindReportItem;
import java.util.Collection;
import jetbrains.mps.errors.item.RuleIdFlavouredItem;
import java.util.Objects;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.internal.collections.runtime.ISelector;

@MPSLaunch
public class SuppressErrorsTest_Test extends BaseTransformationTest {
  @ClassRule
  public static final TestParametersCache ourParamCache = new TestParametersCache(SuppressErrorsTest_Test.class, "${mps_home}", "r:4544cb8b-6ea6-46c1-829b-9d57f2ed0e45(jetbrains.mps.checkers.test@tests)", false);
  @Rule
  public final RunWithCommand myWithCommandRule = new RunWithCommand(this);

  public SuppressErrorsTest_Test() {
    super(ourParamCache);
  }

  @Test
  public void test_noQuotationNoSuppress() throws Throwable {
    new SuppressErrorsTest_Test.TestBody(this).test_noQuotationNoSuppress();
  }
  @Test
  public void test_quotationSuppress() throws Throwable {
    new SuppressErrorsTest_Test.TestBody(this).test_quotationSuppress();
  }
  @Test
  public void test_antiquotationNoSuppress() throws Throwable {
    new SuppressErrorsTest_Test.TestBody(this).test_antiquotationNoSuppress();
  }

  /*package*/ static class TestBody extends BaseTestBody {

    /*package*/ TestBody(TransformationTest owner) {
      super(owner);
    }

    public void test_noQuotationNoSuppress() throws Exception {
      addNodeById("6807933448480843367");
      addNodeById("6807933448480841930");
      addNodeById("6807933448482335857");
      SNode nodeToCheck = SLinkOperations.getTarget(SNodeOperations.cast(getNodeById("6807933448480843367"), SNodeOperations.asSConcept(MetaAdapterFactory.getConcept(MetaAdapterFactory.getLanguage(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, "jetbrains.mps.lang.test"), 0x11b5a38fc01L, "TestNode"))), MetaAdapterFactory.getContainmentLink(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, 0x11b5a38fc01L, 0x11b5a397b92L, "nodeToCheck"));
      List<NodeReportItem> errors = this.runChecker(new TypesystemChecker(), nodeToCheck);
      Assert.assertTrue(ListSequence.fromList(errors).count() == 1 && this.isOurError(ListSequence.fromList(errors).first()));
    }
    public void test_quotationSuppress() throws Exception {
      addNodeById("6807933448480843367");
      addNodeById("6807933448480841930");
      addNodeById("6807933448482335857");
      SNode nodeToCheck = SLinkOperations.getTarget(SNodeOperations.cast(getNodeById("6807933448480841930"), SNodeOperations.asSConcept(MetaAdapterFactory.getConcept(MetaAdapterFactory.getLanguage(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, "jetbrains.mps.lang.test"), 0x11b5a38fc01L, "TestNode"))), MetaAdapterFactory.getContainmentLink(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, 0x11b5a38fc01L, 0x11b5a397b92L, "nodeToCheck"));
      List<NodeReportItem> errors = this.runChecker(new TypesystemChecker(), nodeToCheck);
      Assert.assertTrue(ListSequence.fromList(errors).isEmpty());
    }
    public void test_antiquotationNoSuppress() throws Exception {
      addNodeById("6807933448480843367");
      addNodeById("6807933448480841930");
      addNodeById("6807933448482335857");
      SNode nodeToCheck = SLinkOperations.getTarget(SNodeOperations.cast(getNodeById("6807933448482335857"), SNodeOperations.asSConcept(MetaAdapterFactory.getConcept(MetaAdapterFactory.getLanguage(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, "jetbrains.mps.lang.test"), 0x11b5a38fc01L, "TestNode"))), MetaAdapterFactory.getContainmentLink(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, 0x11b5a38fc01L, 0x11b5a397b92L, "nodeToCheck"));
      List<NodeReportItem> errors = this.runChecker(new TypesystemChecker(), nodeToCheck);
      Assert.assertTrue(ListSequence.fromList(errors).count() == 1 && this.isOurError(ListSequence.fromList(errors).first()));
    }


    public List<NodeReportItem> runChecker(IChecker.AbstractRootChecker<? extends NodeReportItem> checker, SNode root) {
      SModel model = TemporaryModels.getInstance().create(false, false, TempModuleOptions.forDefaultModule());
      SModelOperations.addRootNode(model, SNodeOperations.copyNode(root));
      List<NodeReportItem> result = ListSequence.fromList(new ArrayList<NodeReportItem>());
      checker.check(root, model.getRepository(), new CollectConsumer<NodeReportItem>(result), new EmptyProgressMonitor());
      ImmatureReferences.getInstance().cleanup();
      UnregisteredNodes.instance().clear();
      TemporaryModels.getInstance().dispose(model);
      return result;
    }
    public boolean isOurError(IssueKindReportItem reportItem) {
      Collection<RuleIdFlavouredItem.TypesystemRuleId> errorRules = RuleIdFlavouredItem.FLAVOUR_RULE_ID.getCollection(reportItem);
      return Objects.equals(ListSequence.fromListWithValues(new ArrayList<SNodeReference>(), CollectionSequence.fromCollection(errorRules).select(new ISelector<RuleIdFlavouredItem.TypesystemRuleId, SNodeReference>() {
        public SNodeReference select(RuleIdFlavouredItem.TypesystemRuleId it) {
          return it.getSourceNode();
        }
      })), ListSequence.fromListAndArray(new ArrayList<SNodeReference>(), SNodeOperations.getParent(SNodeOperations.getNode("r:00000000-0000-4000-0000-011c895902c5(jetbrains.mps.baseLanguage.typesystem)", "8292998349249062282")).getReference()));
    }
  }
}

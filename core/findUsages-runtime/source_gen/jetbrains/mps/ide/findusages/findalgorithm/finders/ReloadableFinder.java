package jetbrains.mps.ide.findusages.findalgorithm.finders;

/*Generated by MPS */

import java.lang.ref.WeakReference;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.ide.findusages.FindersManager;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.ide.findusages.model.SearchQuery;
import org.jetbrains.mps.openapi.util.ProgressMonitor;

/**
 * FIXME With proper language aspect, there'd be no need in ReloadableFinder. Language Aspect does all the neccessary classloading management
 */
public class ReloadableFinder implements IInterfacedFinder {
  private final String myFinderIdentity;
  private WeakReference<GeneratedFinder> myFinder;

  public ReloadableFinder(@NotNull String finderClass) {
    myFinderIdentity = finderClass;
    myFinder = new WeakReference<GeneratedFinder>(null);
  }

  public ReloadableFinder(GeneratedFinder finder) {
    myFinderIdentity = finder.getClass().getName();
    myFinder = new WeakReference<GeneratedFinder>(finder);
  }

  public GeneratedFinder getFinder() {
    if (myFinder.get() == null) {
      GeneratedFinder finder = (GeneratedFinder) FindersManager.getInstance().getFinderByClassName(myFinderIdentity, false);
      if (finder != null) {
        myFinder = new WeakReference<GeneratedFinder>(finder);
      }
    }
    return myFinder.get();
  }
  @Override
  public SAbstractConcept getSConcept() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return null;
    }
    return finder.getSConcept();
  }
  @Override
  public boolean isApplicable(SNode node) {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return false;
    }
    return finder.isApplicable(node);
  }
  @Override
  public boolean isVisible(SNode node) {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return false;
    }
    return finder.isVisible(node);
  }
  @Override
  public boolean isUsedByDefault(SNode node) {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return false;
    }
    return finder.isUsedByDefault(node);
  }
  @Override
  public String getDescription() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return "";
    }
    return finder.getDescription();
  }
  @Override
  public String getLongDescription() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return "";
    }
    return finder.getLongDescription();
  }
  @Override
  public boolean canNavigate() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return false;
    }
    return finder.canNavigate();
  }

  @Nullable
  public SNodeReference getDeclarationNode() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return null;
    }
    return FindersManager.getInstance().getDeclarationNode(finder);
  }

  @Override
  public SearchResults<SNode> find(SearchQuery query, ProgressMonitor monitor) {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return new SearchResults();
    }
    return finder.find(query, monitor);
  }
}

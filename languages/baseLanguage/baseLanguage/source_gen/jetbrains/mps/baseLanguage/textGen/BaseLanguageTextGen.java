package jetbrains.mps.baseLanguage.textGen;

/*Generated by MPS */

import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.text.rt.TextGenContext;
import jetbrains.mps.text.impl.TextGenSupport;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.core.behavior.IDeprecatable__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.util.NameUtil;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.baseLanguage.behavior.Classifier__BehaviorDescriptor;
import org.jetbrains.mps.openapi.model.SReference;
import jetbrains.mps.smodel.SNodeUtil;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.smodel.DynamicReference;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import org.jetbrains.mps.openapi.model.SModelReference;
import org.apache.log4j.Level;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.util.JavaNameUtil;
import jetbrains.mps.textGen.TextGen;
import jetbrains.mps.util.InternUtil;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;

public abstract class BaseLanguageTextGen {
  public static void typeParameters(List<SNode> types, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    if (ListSequence.fromList(types).isNotEmpty()) {
      tgs.append("<");
      {
        Iterable<SNode> collection = types;
        final SNode lastItem = Sequence.fromIterable(collection).last();
        for (SNode item : collection) {
          tgs.appendNode(item);
          if (item != lastItem) {
            tgs.append(", ");
          }
        }
      }
      tgs.append(">");
    }
  }
  public static void arguments(SNode methodCall, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    tgs.append("(");
    {
      Iterable<SNode> collection = SLinkOperations.getChildren(methodCall, MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x11857355952L, 0xf8c78301aeL, "actualArgument"));
      final SNode lastItem = Sequence.fromIterable(collection).last();
      for (SNode item : collection) {
        tgs.appendNode(item);
        if (item != lastItem) {
          tgs.append(", ");
        }
      }
    }
    tgs.append(")");
  }
  public static void newLine(boolean need, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    if (need) {
      tgs.newLine();
    }
  }
  public static void annotations(SNode annotable, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    for (SNode item : SLinkOperations.getChildren(annotable, MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x114a6be947aL, 0x114a6beb0bdL, "annotation"))) {
      tgs.appendNode(item);
    }
    if (SNodeOperations.isInstanceOf(annotable, MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x11d205fe38dL, "jetbrains.mps.lang.core.structure.IDeprecatable")) && (boolean) IDeprecatable__BehaviorDescriptor.isDeprecated_idhOwoPtR.invoke(SNodeOperations.cast(annotable, MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x11d205fe38dL, "jetbrains.mps.lang.core.structure.IDeprecatable")))) {
      boolean containsDeprecated = false;
      for (SNode annotationInstance : SLinkOperations.getChildren(annotable, MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x114a6be947aL, 0x114a6beb0bdL, "annotation"))) {
        if (SLinkOperations.getTarget(annotationInstance, MetaAdapterFactory.getReferenceLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x114a6b4ccabL, 0x114a6b85d40L, "annotation")) == SNodeOperations.getNode("6354ebe7-c22a-4a0f-ac54-50b52ab9b065/java:java.lang(JDK/)", "~Deprecated")) {
          containsDeprecated = true;
          break;
        }
      }
      if (!(containsDeprecated)) {
        SNode deprecated = SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x114a6b4ccabL, "jetbrains.mps.baseLanguage.structure.AnnotationInstance")));
        SLinkOperations.setTarget(deprecated, MetaAdapterFactory.getReferenceLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x114a6b4ccabL, 0x114a6b85d40L, "annotation"), SNodeOperations.getNode("6354ebe7-c22a-4a0f-ac54-50b52ab9b065/java:java.lang(JDK/)", "~Deprecated"));
        tgs.appendNode(deprecated);
      }
    }
  }
  public static void visibility(SNode v, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    if ((v == null)) {
      tgs.append("/*package*/ ");
    } else {
      tgs.appendNode(v);
    }
  }
  public static void visibilityWithIndent(SNode v, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    tgs.indent();
    BaseLanguageTextGen.visibility(v, ctx);
  }
  public static void internalClassifierName(SNode node, SNode contextNode, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    if ((node == null)) {
      tgs.append("???");
      tgs.reportError("classifier is null");
      return;
    }
    BaseLanguageTextGen.appendClassName(BaseLanguageTextGen.getPackageName(node, ctx), NameUtil.longNameFromNamespaceAndShortName(BaseLanguageTextGen.getPackageName(node, ctx), SPropertyOperations.getString(node, MetaAdapterFactory.getProperty(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x101d9d3ca30L, 0x11a134c900dL, "nestedName"))), contextNode, ctx);
  }
  public static void internalClassName(String packageName, String className, SNode contextNode, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    BaseLanguageTextGen.appendClassName(packageName, NameUtil.longNameFromNamespaceAndShortName(packageName, className), contextNode, ctx);
  }
  public static void variableDeclaration(SNode node, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    if (SPropertyOperations.getBoolean(node, MetaAdapterFactory.getProperty(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8c37a7f6eL, 0x111f9e9f00cL, "isFinal"))) {
      tgs.append("final ");
    }
    tgs.appendNode(SLinkOperations.getTarget(node, MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x450368d90ce15bc3L, 0x4ed4d318133c80ceL, "type")));
    tgs.append(" ");
    tgs.append(SPropertyOperations.getString(node, MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name")));
    if ((SLinkOperations.getTarget(node, MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8c37a7f6eL, 0xf8c37f506eL, "initializer")) != null)) {
      tgs.append(" = ");
      tgs.appendNode(SLinkOperations.getTarget(node, MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8c37a7f6eL, 0xf8c37f506eL, "initializer")));
    }
  }
  public static void fileHeader(SNode cls, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    boolean topClassifier = !((boolean) Classifier__BehaviorDescriptor.isInner_idsWroEc0xXl.invoke(cls));
    if (topClassifier) {
      tgs.pushTextArea("HEADER");
      tgs.append("package " + BaseLanguageTextGen.getPackageName(cls, ctx) + ";");
      tgs.newLine();
      tgs.newLine();
      tgs.append("/*Generated by MPS */");
      tgs.newLine();
      tgs.newLine();
      tgs.popTextArea();
      tgs.pushTextArea("SEPARATOR");
      tgs.newLine();
      tgs.popTextArea();
    }
    if (SNodeOperations.isInstanceOf(cls, MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x101edd46144L, "jetbrains.mps.baseLanguage.structure.Interface"))) {
      BaseLanguageTextGen.registerExtendsRelation(SLinkOperations.getChildren(SNodeOperations.cast(cls, MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x101edd46144L, "jetbrains.mps.baseLanguage.structure.Interface")), MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x101edd46144L, 0x101eddadad7L, "extendedInterface")), topClassifier, ctx);
    } else if (SNodeOperations.isInstanceOf(cls, MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8c108ca66L, "jetbrains.mps.baseLanguage.structure.ClassConcept"))) {
      BaseLanguageTextGen.registerExtendsRelation(SLinkOperations.getChildren(SNodeOperations.cast(cls, MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8c108ca66L, "jetbrains.mps.baseLanguage.structure.ClassConcept")), MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8c108ca66L, 0xff2ac0b419L, "implementedInterface")), topClassifier, ctx);
      BaseLanguageTextGen.registerExtendsRelation(Sequence.fromIterable(Sequence.<SNode>singleton(SLinkOperations.getTarget(SNodeOperations.cast(cls, MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8c108ca66L, "jetbrains.mps.baseLanguage.structure.ClassConcept")), MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8c108ca66L, 0x10f6353296dL, "superclass")))).toListSequence(), topClassifier, ctx);
    }
  }
  public static void methodCall(SNode methodCall, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    BaseLanguageTextGen.methodTypeArguments(methodCall, ctx);
    BaseLanguageTextGen.referenceToShortName(SNodeOperations.getReference(methodCall, MetaAdapterFactory.getReferenceLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x11857355952L, 0xf8c78301adL, "baseMethodDeclaration")), ctx);
    BaseLanguageTextGen.arguments(methodCall, ctx);
  }
  public static void methodTypeArguments(SNode methodCall, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    if (ListSequence.fromList(SLinkOperations.getChildren(methodCall, MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x11857355952L, 0x4500f31eb02a7788L, "typeArgument"))).isNotEmpty()) {
      tgs.append("<");
      {
        Iterable<SNode> collection = SLinkOperations.getChildren(methodCall, MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x11857355952L, 0x4500f31eb02a7788L, "typeArgument"));
        final SNode lastItem = Sequence.fromIterable(collection).last();
        for (SNode item : collection) {
          tgs.appendNode(item);
          if (item != lastItem) {
            tgs.append(",");
          }
        }
      }
      tgs.append(">");
    }
  }
  public static void referenceToShortName(SReference reference, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    if (reference == null) {
      tgs.reportError("null reference");
      tgs.append("???");
      return;
    }
    SNode targetNode = reference.getTargetNode();
    if (targetNode == null) {
      tgs.reportError(String.format("Unknown target for role %s", reference.getLink()));
      tgs.append("???");
      return;
    }
    String name = SNodeUtil.getResolveInfo(targetNode);
    if (name == null) {
      tgs.reportError(String.format("No resolve info for node %s", targetNode));
      name = targetNode.getName();
    }
    if (name == null) {
      tgs.append("???");
    } else {
      tgs.append(name);
    }

  }
  public static void blClassifierRef(SReference classifierRef, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    if (classifierRef == null) {
      tgs.reportError("null classifier ref");
      return;
    }
    Tuples._2<String, String> packageAndShortName = BaseLanguageTextGen.getPackageAndShortName(classifierRef, ctx);
    if (packageAndShortName == null) {
      return;
    }
    String longName = NameUtil.longNameFromNamespaceAndShortName(packageAndShortName._0(), packageAndShortName._1());
    BaseLanguageTextGen.appendClassName(packageAndShortName._0(), longName, classifierRef.getSourceNode(), ctx);
  }
  protected static Tuples._2<String, String> getPackageAndShortName(SReference classifierRef, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    SReference reference = classifierRef;
    if (reference == null) {
      tgs.reportError("null reference");
      return null;
    }
    String shortName = "";
    String packageName = "";
    if (reference instanceof DynamicReference) {
      shortName = ((jetbrains.mps.smodel.SReference) reference).getResolveInfo();
      // hack, todo: remove! 
      if (shortName.startsWith("[")) {
        return MultiTuple.<String,String>from(shortName.substring(1, shortName.lastIndexOf("]")).trim(), shortName.substring(shortName.lastIndexOf("]") + 1).trim());
      } else {
        // todo: remove! 
        final SModelReference modelReference = reference.getTargetSModelReference();
        if (modelReference != null) {
          packageName = modelReference.getName().getLongName();
          if (LOG.isEnabledFor(Level.WARN)) {
            LOG.warn("generating classifier reference with target model reference " + modelReference + " @ " + classifierRef);
          }
        } else {
          int lastDot = shortName.lastIndexOf('.');
          if (lastDot >= 0) {
            packageName = shortName.substring(0, lastDot);
            shortName = shortName.substring(lastDot + 1).replace('$', '.');
          } else {
            SModel sModel = classifierRef.getSourceNode().getModel();
            packageName = (sModel != null ? sModel.getName().getLongName() : "");
          }
        }
        return MultiTuple.<String,String>from(packageName, shortName);
      }
    } else {
      SNode targetNode = jetbrains.mps.util.SNodeOperations.getTargetNodeSilently(reference);
      if (targetNode == null) {
        tgs.reportError("Target node is null for reference to classifier with role " + SLinkOperations.getRole(classifierRef) + "; resolve info " + SLinkOperations.getResolveInfo(classifierRef) + "; " + jetbrains.mps.util.SNodeOperations.getDebugText(classifierRef.getSourceNode()));
        return null;
      }
      return MultiTuple.<String,String>from(SModelOperations.getModelName(SNodeOperations.getModel(targetNode)), (SNodeOperations.isInstanceOf(targetNode, MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x101d9d3ca30L, "jetbrains.mps.baseLanguage.structure.Classifier")) ? SPropertyOperations.getString(SNodeOperations.cast(targetNode, MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x101d9d3ca30L, "jetbrains.mps.baseLanguage.structure.Classifier")), MetaAdapterFactory.getProperty(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x101d9d3ca30L, 0x11a134c900dL, "nestedName")) : jetbrains.mps.util.SNodeOperations.getResolveInfo(targetNode)));
    }
  }
  protected static Set<String> getUserObjects(String type, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    Set<String> names = (Set<String>) tgs.getLegacyBuffer().getUserObject(type);
    if (names == null) {
      names = SetSequence.fromSet(new HashSet<String>());
      tgs.getLegacyBuffer().putUserObject(type, names);
    }
    return names;
  }
  protected static String getPackageName(SNode cls, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    return SModelOperations.getModelName(SNodeOperations.getModel(cls));
  }
  protected static String getClassName(String packageName, String fqName, SNode contextNode, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    if (fqName == null) {
      tgs.reportError("class name is NULL");
      return "???";
    }

    BaseLanguageTextGen.addDependency(packageName, fqName, ctx);
    ImportEntry importEntry = ImportsContext.getInstance(tgs.getLegacyBuffer()).getClassifierRefText(packageName, fqName, contextNode);
    if (importEntry.needsImport()) {
      tgs.pushTextArea("IMPORTS");
      tgs.append("import ");
      tgs.append(importEntry.getImport());
      tgs.append(";");
      tgs.newLine();
      tgs.popTextArea();
    }
    return importEntry.getName();
  }
  protected static void addDependency(String packageName, String fqName, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    // using only root classifiers as dependencies 
    String nestedName = JavaNameUtil.nestedClassName(packageName, fqName);
    int dotIndex = nestedName.indexOf(".");
    String dependencyFqName;
    if (dotIndex == -1) {
      dependencyFqName = fqName;
    } else {
      dependencyFqName = packageName + "." + nestedName.substring(0, dotIndex);
    }
    BaseLanguageTextGen.addDependency(dependencyFqName, ctx);
  }
  protected static void addDependency(String fqName, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    Set<String> dependencies = BaseLanguageTextGen.getUserObjects(TextGen.DEPENDENCY, ctx);
    SetSequence.fromSet(dependencies).addElement(InternUtil.intern(fqName));
  }
  protected static void appendClassName(String packageName, String fqName, SNode contextNode, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    tgs.append(BaseLanguageTextGen.getClassName(packageName, fqName, contextNode, ctx));
  }
  protected static void registerExtendsRelation(List<SNode> classifiers, boolean isTopClassifier, final TextGenContext ctx) {
    final TextGenSupport tgs = new TextGenSupport(ctx);
    // if an inner class extends/implements outer classifier, we shall not record this dependency as 'extends' of a 
    // top-level unit (see sample in MPS-17604). Perhaps, we shall not record this dependency at all? 
    Set<String> dependencies = BaseLanguageTextGen.getUserObjects((isTopClassifier ? TextGen.EXTENDS : TextGen.DEPENDENCY), ctx);
    for (SNode c : classifiers) {
      SetSequence.fromSet(dependencies).addElement(NameUtil.nodeFQName(SLinkOperations.getTarget(c, MetaAdapterFactory.getReferenceLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x101de48bf9eL, 0x101de490babL, "classifier"))));
    }
  }
  protected static Logger LOG = LogManager.getLogger(BaseLanguageTextGen.class);
}

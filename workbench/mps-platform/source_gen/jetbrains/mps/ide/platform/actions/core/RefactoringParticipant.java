package jetbrains.mps.ide.platform.actions.core;

/*Generated by MPS */

import java.util.List;
import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.mps.openapi.module.SearchScope;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.ide.findusages.model.SearchResults;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.IVisitor;

public interface RefactoringParticipant<InitialDataObject, FinalDataObject, InitialPoint, FinalPoint> {

  static interface RefactoringDataCollector<InitialDataObject, FinalDataObject, InitialPoint, FinalPoint> {
    InitialDataObject beforeMove(InitialPoint nodeToMove);
    FinalDataObject afterMove(FinalPoint movedNode);
  }

  RefactoringParticipant.RefactoringDataCollector<InitialDataObject, FinalDataObject, InitialPoint, FinalPoint> getDataCollector();

  class Option {
    private String myId;
    private String myDescription;
    public Option(String id, String description) {
      myId = id;
      myDescription = description;
    }
    public String getId() {
      return myId;
    }
    public String getDescription() {
      return myDescription;
    }
    public int hashCode() {
      return myId.hashCode();
    }
    public boolean equals(Object object) {
      return object instanceof RefactoringParticipant.Option && eq_g5nieh_a0a0a6f(((RefactoringParticipant.Option) object).getId(), this.getId());
    }
    private static boolean eq_g5nieh_a0a0a6f(Object a, Object b) {
      return (a != null ? a.equals(b) : a == b);
    }
  }

  List<RefactoringParticipant.Option> getAvailableOptions(InitialDataObject initialState, SRepository repository);

  List<RefactoringParticipant.Change<InitialDataObject, FinalDataObject>> getChanges(InitialDataObject initialState, SRepository repository, List<RefactoringParticipant.Option> selectedOptions, SearchScope searchScope, ProgressMonitor progressMonitor);

  static interface Change<InitialDataObject, FinalDataObject> {
    SearchResults getSearchResults();
    boolean needsToPreserveOldNode();
    void confirm(FinalDataObject finalState, SRepository repository, RefactoringSession refactoringSession);
  }

  static interface PersistentRefactoringParticipant<InitialDataObject, FinalDataObject, InitialPoint, FinalPoint> extends RefactoringParticipant<InitialDataObject, FinalDataObject, InitialPoint, FinalPoint> {
    String getId();
    SNode serializeInitialState(InitialDataObject initialState);
    InitialDataObject deserializeInitialState(SNode serialized);
    SNode serializeFinalState(FinalDataObject finalState);
    FinalDataObject deserializeFinalState(SNode serialized);
  }

  class ParticipantState<I, F, IP, FP> {
    private RefactoringParticipant<I, F, IP, FP> myParticipant;
    private I myInitialState;
    private List<RefactoringParticipant.Change<I, F>> changes;
    public List<RefactoringParticipant.Change<I, F>> getChanges() {
      return changes;
    }
    public RefactoringParticipant<I, F, IP, FP> getParticipant() {
      return myParticipant;
    }
    public I getInitialState() {
      return myInitialState;
    }
    public static <I, F, IP, FP> RefactoringParticipant.ParticipantState<I, F, IP, FP> create(RefactoringParticipant<I, F, IP, FP> participant, IP oldNode) {
      return new RefactoringParticipant.ParticipantState<I, F, IP, FP>(participant, oldNode);
    }
    public ParticipantState(RefactoringParticipant<I, F, IP, FP> participant, IP oldNode) {
      this.myParticipant = participant;
      myInitialState = this.myParticipant.getDataCollector().beforeMove(oldNode);
    }
    public List<RefactoringParticipant.Option> getAvaliableOptions(SRepository repository) {
      return myParticipant.getAvailableOptions(myInitialState, repository);
    }
    public List<RefactoringParticipant.Change<I, F>> findChanges(SRepository repository, List<RefactoringParticipant.Option> selectedOptions, SearchScope searchScope, ProgressMonitor progressMonitor) {
      return changes = initChanges(repository, selectedOptions, searchScope, progressMonitor);
    }
    protected List<RefactoringParticipant.Change<I, F>> initChanges(SRepository repository, List<RefactoringParticipant.Option> selectedOptions, SearchScope searchScope, ProgressMonitor progressMonitor) {
      return myParticipant.getChanges(myInitialState, repository, selectedOptions, searchScope, progressMonitor);
    }
    public void confirm(FP newNode, final SRepository repository, final RefactoringSession session) {
      final F finalState = this.myParticipant.getDataCollector().afterMove(newNode);
      ListSequence.fromList(this.changes).visitAll(new IVisitor<RefactoringParticipant.Change<I, F>>() {
        public void visit(RefactoringParticipant.Change<I, F> it) {
          it.confirm(finalState, repository, session);
        }
      });
    }
  }


}
